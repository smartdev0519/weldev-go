env GO111MODULE=on
env GOPROXY=off

[!gc] skip

# Outside of GOROOT, our vendored packages should be reported as part of the standard library.
go list -f '{{if .Standard}}{{.ImportPath}}{{end}}' std cmd
stdout ^internal/x/net/http2/hpack
stdout ^cmd/vendor/golang\.org/x/arch/x86/x86asm

# cmd/... should match the same packages it used to match in GOPATH mode.
go list cmd/...
stdout ^cmd/compile
! stdout ^cmd/vendor/golang\.org/x/arch/x86/x86asm


# Within the std module, listing ./... should omit the 'std' prefix:
# the package paths should be the same via ./... or the 'std' meta-pattern.
# TODO(golang.org/issue/30241): Make that work.
# Today, they are listed in 'std' but not './...'.
cd $GOROOT/src
go list ./...
stdout ^internal/x

cp stdout $WORK/listdot.txt
go list std
stdout ^internal/x
# TODO: cmp stdout $WORK/listdot.txt

go list all
stdout ^internal/x
! stdout ^std/


# Within the std module, the vendored dependencies of std should appear
# to come from the actual modules.
# TODO(golang.org/issue/30241): Make that work.
# Today, they still have the vendor/ prefix.
go list std
stdout ^internal/x/net/http2/hpack  # TODO
! stdout ^golang.org/x/net/http2/hpack       # TODO

go list -deps -f '{{if not .Standard}}{{.ImportPath}}{{end}}' std
# ! stdout ^internal/x/net/http2/hpack  # TODO
! stdout ^golang.org/x/net/http2/hpack         # TODO


# Within std, the vendored dependencies of cmd should still appear to be part of cmd.
go list -f '{{if .Standard}}{{.ImportPath}}{{end}}' cmd
stdout ^cmd/vendor/golang\.org/x/arch/x86/x86asm

go list -f '{{if not .Standard}}{{.ImportPath}}{{end}}' cmd
! stdout .

go list cmd/...
stdout ^cmd/compile
! stdout ^cmd/vendor/golang\.org/x/arch/x86/x86asm
